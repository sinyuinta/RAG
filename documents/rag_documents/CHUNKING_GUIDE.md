# RAG用チャンク分割ガイド

## このガイドの目的

本ガイドは、心理学理論文書をRAGシステムに組み込む際のチャンク分割ルールを定めたものです。心理学の専門知識がなくても、このルールに従えば適切な分割ができます。

---

## 基本原則

1. **トークン数による機械的分割は禁止**
2. **見出し構造に基づいて分割する**
3. **1チャンク＝1つの理論的まとまり**
4. **メタデータは全チャンクに付与する**

---

## 分割ルール

### ルール1：レベル2見出し（##）で大分割

各文書は以下の##セクションを持つ。これが最上位の分割単位。

| セクション | 内容 |
|-----------|------|
| `## メタデータ` | チャンクには含めない（後述の方法で各チャンクに付与） |
| `## 1. 理論の骨格` | 分割対象 |
| `## 2. 理論の力点` | 分割対象 |
| `## 3. 誤解されやすい点` | 分割対象 |
| `## 4. 実践での留意点` | 分割対象 |
| `## 主要文献` | 分割対象（独立チャンク） |

### ルール2：レベル3見出し（###）でさらに分割

`## 1. 理論の骨格` 内は、###単位でチャンク化する。

例（Adler文書の場合）：
```
### 1.1 基本前提        → チャンク1
### 1.2 中核概念        → チャンク2（長い場合は後述のルール3適用）
### 1.3 理論構造        → チャンク3
```

他のセクション（## 2〜4）は、###がある場合は###単位、ない場合は##全体を1チャンクとする。

### ルール3：長い###セクションの分割

###セクションが**約2000トークンを超える**場合、####（レベル4見出し）で分割する。

例（`### 1.2 中核概念`が長い場合）：
```
#### （1）劣等感と補償    → チャンク2a
#### （2）ライフスタイル  → チャンク2b
#### （3）共同体感覚      → チャンク2c
```

本文書では、####の代わりに`**（1）太字見出し**`を使っている箇所がある。これも分割ポイントとして扱う。

### ルール4：分割してはいけない箇所

以下は分割しない：

- 箇条書きの途中
- 「例：」で始まる具体例とその直前の説明
- コードブロック（```で囲まれた部分）の途中
- 表の途中

---

## メタデータの扱い

### 各チャンクに付与するメタデータ

元ファイルの`## メタデータ`セクションから以下を抽出し、**すべてのチャンクに付与**する：

```yaml
ancestor: Adler          # 始祖
family_line: IndividualPsychology  # 学派
source_author: Alfred Adler  # 著者
role: ancestor_core      # ancestor_core または descendant_extension
level: foundation        # foundation または applied
```

### チャンク固有のメタデータ

さらに、各チャンクに以下を追加：

```yaml
chunk_type: core_concept | premise | structure | application | boundary | caution | references
section_title: "1.2 中核概念 - 劣等感と補償"  # セクション名
```

`chunk_type`の対応：
| セクション | chunk_type |
|-----------|------------|
| 1.1 基本前提 | premise |
| 1.2 中核概念 | core_concept |
| 1.3 理論構造 | structure |
| 2. 理論の力点 | application |
| 3. 誤解されやすい点 | boundary |
| 4. 実践での留意点 | caution |
| 主要文献 | references |

---

## 実例：adler_core.md の分割

```
チャンク1: メタデータ + 1.1 基本前提（全体論〜創造的自己）
チャンク2: メタデータ + 1.2 中核概念 - 劣等感と補償
チャンク3: メタデータ + 1.2 中核概念 - ライフスタイル
チャンク4: メタデータ + 1.2 中核概念 - 共同体感覚
チャンク5: メタデータ + 1.2 中核概念 - 虚構とAs If
チャンク6: メタデータ + 1.3 理論構造
チャンク7: メタデータ + 2.1 説明範囲
チャンク8: メタデータ + 2.2 実践との接続点
チャンク9: メタデータ + 3. 誤解されやすい点（全体で1チャンク可、または3.1〜3.4で分割）
チャンク10: メタデータ + 4. 実践での留意点（全体で1チャンク可、または4.1〜4.5で分割）
チャンク11: メタデータ + 主要文献
```

---

## トークン数の目安

| 状況 | 対応 |
|------|------|
| 500トークン未満 | 前後のチャンクと統合を検討 |
| 500〜2000トークン | 理想的 |
| 2000〜3000トークン | 許容範囲 |
| 3000トークン超 | 下位見出しで分割 |

※ただし、トークン数より**意味的まとまり**を優先すること。

---

## Contextual Retrieval用の文脈付与

OpenAI Contextual Retrievalを使用する場合、各チャンクの先頭に以下の形式で文脈を付与する：

```
[文脈] このチャンクは「{ancestor}」学派の「{source_author}」による理論文書の「{section_title}」セクションです。{family_line}の{role}として、{theory_tag}に関する内容を含みます。

[本文]
（チャンク本文）
```

例：
```
[文脈] このチャンクは「Adler」学派の「Alfred Adler」による理論文書の「1.2 中核概念 - 共同体感覚」セクションです。IndividualPsychologyのancestor_coreとして、social_interestに関する内容を含みます。

[本文]
共同体感覚（Gemeinschaftsgefühl / Social Interest）

アドラー心理学の最も独自の概念であり、かつ最も誤解されやすい概念。
（以下本文）
```

---

## チェックリスト

分割完了後、以下を確認：

- [ ] 各チャンクにメタデータが付与されているか
- [ ] 箇条書きや表が途中で切れていないか
- [ ] 「例：」が直前の説明から分離されていないか
- [ ] 極端に短い（500トークン未満）チャンクがないか
- [ ] 極端に長い（3000トークン超）チャンクがないか
- [ ] chunk_typeが正しく設定されているか

---

## 質問がある場合

分割判断に迷った場合は、以下の優先順位で判断：

1. **意味的まとまりを保つ**（最優先）
2. **見出し構造に従う**
3. **トークン数を調整する**（最後）

それでも判断できない場合は、「分割しない」側に倒す。過度な分割より、やや長いチャンクの方が検索品質は維持される。

---

## ファイル一覧と特記事項

| ファイル | 特記事項 |
|----------|----------|
| adler_core.md | 中核概念が4つに分かれる |
| adler_dreikurs.md | 「誤った目的の4段階」は分割しない |
| freud_core.md | 構造論・局所論は別チャンク |
| freud_object_relations.md | 理論家ごと（Klein, Winnicott等）に分割可 |
| jung_core.md | 元型の説明が長い、個別分割推奨 |
| neisser_kahneman.md | システム1/2、ヒューリスティクス、プロスペクト理論は別チャンク |

他のファイルは標準ルールで対応可能。
